WITH 
CFOP_SAIDAS_ORDENADAS AS (
    SELECT DISTINCT CODI_EMP, I_CFOP_ENTRADA, CFOP
    FROM bethadba.EFIMPORTADOR_FIXO_NFE_ENTRADA_CFOP_SAIDA
),

BASE AS (
    SELECT 
        cfop.*,
        emp.NOME_EMP,
        ncm.NCM,
        saida_ordenada.CFOP AS CFOP_SAIDA,
        acu_ncm_join.CODI_ACU AS ACU_NCM,
        acu_cfop_only_join.CODI_ACU AS ACU_CFOP,
        acu_cfop_only_join.I_ACUMULADOR AS I_ACU_CFOP,
        efac.NOME_ACU,
        
        CASE 
          WHEN acu_ncm_join.CODI_ACU IS NULL 
               AND acu_cfop_only_join.CODI_ACU IS NOT NULL
               AND NOT EXISTS (
                   SELECT 1
                   FROM bethadba.EFIMPORTADOR_FIXO_NFE_ENTRADA_ACUMULADOR_NCM acu_ncm_sub
                   WHERE acu_ncm_sub.CODI_EMP = cfop.CODI_EMP
                     AND acu_ncm_sub.I_ACUMULADOR = acu_cfop_only_join.I_ACUMULADOR
               )
            THEN 'ST-' || CAST(acu_cfop_only_join.CODI_ACU AS VARCHAR)
          ELSE CAST(COALESCE(acu_ncm_join.CODI_ACU, acu_cfop_only_join.CODI_ACU) AS VARCHAR)
        END AS CODI_ACUMULADOR_FORMATADO

    FROM bethadba.EFIMPORTADOR_FIXO_NFE_ENTRADA_CFOP cfop

    LEFT JOIN bethadba.geempre emp ON emp.CODI_EMP = cfop.CODI_EMP

    LEFT JOIN CFOP_SAIDAS_ORDENADAS saida_ordenada
        ON cfop.CODI_EMP = saida_ordenada.CODI_EMP
       AND cfop.I_CFOP_ENTRADA = saida_ordenada.I_CFOP_ENTRADA

    INNER JOIN bethadba.EFIMPORTADOR_FIXO_NFE_ENTRADA_CFOP_NCM ncm
        ON cfop.CODI_EMP = ncm.CODI_EMP
       AND cfop.I_CFOP_ENTRADA = ncm.I_CFOP_ENTRADA

    LEFT JOIN bethadba.EFIMPORTADOR_FIXO_NFE_ENTRADA_ACUMULADOR_NCM acu_ncm
        ON acu_ncm.CODI_EMP = cfop.CODI_EMP AND acu_ncm.NCM = ncm.NCM

    LEFT JOIN bethadba.EFIMPORTADOR_FIXO_NFE_ENTRADA_ACUMULADOR_CFOP acu_cfop
        ON acu_cfop.CODI_EMP = cfop.CODI_EMP AND acu_cfop.CFOP = cfop.CFOP AND acu_cfop.I_ACUMULADOR = acu_ncm.I_ACUMULADOR

    LEFT JOIN bethadba.EFIMPORTADOR_FIXO_NFE_ENTRADA_ACUMULADOR acu_ncm_join
        ON acu_ncm_join.CODI_EMP = cfop.CODI_EMP AND acu_ncm_join.I_ACUMULADOR = acu_ncm.I_ACUMULADOR

    LEFT JOIN bethadba.EFIMPORTADOR_FIXO_NFE_ENTRADA_ACUMULADOR_CFOP acu_cfop_only
        ON acu_cfop_only.CODI_EMP = cfop.CODI_EMP AND acu_cfop_only.CFOP = cfop.CFOP

    LEFT JOIN bethadba.EFIMPORTADOR_FIXO_NFE_ENTRADA_ACUMULADOR acu_cfop_only_join
        ON acu_cfop_only_join.CODI_EMP = cfop.CODI_EMP AND acu_cfop_only_join.I_ACUMULADOR = acu_cfop_only.I_ACUMULADOR

    LEFT JOIN bethadba.efacumulador efac
        ON efac.CODI_EMP = cfop.CODI_EMP AND efac.CODI_ACU = COALESCE(acu_ncm_join.CODI_ACU, acu_cfop_only_join.CODI_ACU)

    WHERE emp.CODI_EMP = :COD_EMP
)

SELECT 
    CODI_EMP AS COD_EMP,
    NOME_EMP,
    CAST(CFOP AS VARCHAR) AS CFOP_ENT,
    LIST(DISTINCT CFOP_SAIDA ORDER BY CFOP_SAIDA) AS CFOP_SAI,

    SUBSTRING(RIGHT('00000000' || NCM, 8), 1, 4) || '-' ||
    SUBSTRING(RIGHT('00000000' || NCM, 8), 5, 2) || '-' ||
    SUBSTRING(RIGHT('00000000' || NCM, 8), 7, 2) AS NCM,

    CODI_ACUMULADOR_FORMATADO AS CODI_ACUMULADOR,
    COALESCE(NOME_ACU, '') AS NOME_ACUMULADOR

FROM BASE

GROUP BY 
    CODI_EMP, NOME_EMP, CFOP, NCM, 
    CODI_ACUMULADOR_FORMATADO, 
    NOME_ACU


UNION


SELECT 
    emp.CODI_EMP AS COD_EMP,
    emp.NOME_EMP AS NOME_EMPRESA,
    CASE 
      WHEN acu_cfop.CFOP IS NOT NULL THEN 'ST-' || CAST(acu_cfop.CFOP AS VARCHAR)
      ELSE 'ST-(sem CFOP)'
    END AS CFOP_ENT,
    LIST(DISTINCT acu_cfop.CFOP ORDER BY acu_cfop.CFOP) AS CFOP_SAI,

    SUBSTRING(RIGHT('00000000' || acu_ncm.NCM, 8), 1, 4) || '-' ||
    SUBSTRING(RIGHT('00000000' || acu_ncm.NCM, 8), 5, 2) || '-' ||
    SUBSTRING(RIGHT('00000000' || acu_ncm.NCM, 8), 7, 2) AS NCM,

    CAST(acu.CODI_ACU AS VARCHAR) AS CODI_ACUMULADOR,

    COALESCE(efac.NOME_ACU, '') AS NOME_ACUMULADOR

FROM bethadba.EFIMPORTADOR_FIXO_NFE_ENTRADA_ACUMULADOR_NCM acu_ncm

INNER JOIN bethadba.EFIMPORTADOR_FIXO_NFE_ENTRADA_ACUMULADOR acu
    ON acu.CODI_EMP = acu_ncm.CODI_EMP AND acu.I_ACUMULADOR = acu_ncm.I_ACUMULADOR

LEFT JOIN bethadba.EFIMPORTADOR_FIXO_NFE_ENTRADA_ACUMULADOR_CFOP acu_cfop
    ON acu_cfop.CODI_EMP = acu_ncm.CODI_EMP AND acu_cfop.I_ACUMULADOR = acu_ncm.I_ACUMULADOR

LEFT JOIN bethadba.geempre emp ON emp.CODI_EMP = acu_ncm.CODI_EMP

LEFT JOIN bethadba.efacumulador efac
    ON efac.CODI_EMP = acu.CODI_EMP AND efac.CODI_ACU = acu.CODI_ACU

WHERE emp.CODI_EMP = :COD_EMP
  AND NOT EXISTS (
      SELECT 1 
      FROM bethadba.EFIMPORTADOR_FIXO_NFE_ENTRADA_CFOP_NCM cfop_ncm
      WHERE cfop_ncm.CODI_EMP = acu_ncm.CODI_EMP
        AND cfop_ncm.NCM = acu_ncm.NCM
)

GROUP BY 
    emp.CODI_EMP, emp.NOME_EMP, acu_cfop.CFOP, acu_ncm.NCM,
    acu.CODI_ACU, efac.NOME_ACU
