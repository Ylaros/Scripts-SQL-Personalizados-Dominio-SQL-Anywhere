SELECT
    E.CODI_EMP,
    CAST(E.I_CFE AS VARCHAR(20)) AS I_CFE,
    E.EXTRATO,
    E.SAT,
    E.DATA_CFE,
    EI.CODI_ACU,
    EID.CODI_NAT,
    E.VALOR_TOTAL_CFE,
    E.SITUACAO,
    E.CODI_USU,
    E.IDENTIFICACAO,
    G.nome_imp,
    EID.VALOR_IMPOSTO,
    EID.VALOR_ISENTAS,
    EID.VALOR_OUTROS,
    EID.BASE_CALCULO
FROM bethadba.EFCUPOM_FISCAL_ELETRONICO E
LEFT JOIN bethadba.EFCUPOM_FISCAL_ELETRONICO_IMPOSTOS EI
    ON EI.CODI_EMP = E.CODI_EMP AND EI.I_CFE = E.I_CFE
LEFT JOIN bethadba.EFCUPOM_FISCAL_ELETRONICO_IMPOSTOS_DETALHAMENTO EID
    ON EID.CODI_EMP = E.CODI_EMP AND EID.I_CFE = E.I_CFE
LEFT JOIN bethadba.geimposto G
    ON G.CODI_EMP = EID.CODI_EMP AND G.CODI_IMP = EID.CODI_IMP
WHERE E.DATA_CFE BETWEEN :d_ini AND :d_fim

UNION ALL

SELECT
    E.CODI_EMP,
    CAST(E.I_CFE AS VARCHAR(20)) || '-C' AS I_CFE,
    E.EXTRATO_CANCELAMENTO AS EXTRATO,
    E.SAT,
    E.DATA_CFE,
    EI.CODI_ACU,
    EID.CODI_NAT,
    E.VALOR_TOTAL_CFE,
    E.SITUACAO,
    E.CODI_USU,
    E.IDENTIFICACAO,
    G.nome_imp,
    EID.VALOR_IMPOSTO,
    EID.VALOR_ISENTAS,
    EID.VALOR_OUTROS,
    EID.BASE_CALCULO
FROM bethadba.EFCUPOM_FISCAL_ELETRONICO E
LEFT JOIN bethadba.EFCUPOM_FISCAL_ELETRONICO_IMPOSTOS EI
    ON EI.CODI_EMP = E.CODI_EMP AND EI.I_CFE = E.I_CFE
LEFT JOIN bethadba.EFCUPOM_FISCAL_ELETRONICO_IMPOSTOS_DETALHAMENTO EID
    ON EID.CODI_EMP = E.CODI_EMP AND EID.I_CFE = E.I_CFE
LEFT JOIN bethadba.geimposto G
    ON G.CODI_EMP = EID.CODI_EMP AND G.CODI_IMP = EID.CODI_IMP
WHERE 
    E.DATA_CFE BETWEEN :d_ini AND :d_fim
    AND COALESCE(E.EXTRATO_CANCELAMENTO, '') <> ''
